# iOS Native App - Complete Fastlane Integration Guide

Complete guide for integrating fastlane into iOS native applications, covering screenshots, metadata management, and App Store releases.

## Overview

This guide covers the complete workflow for iOS apps built with Swift/SwiftUI/UIKit, using:
- **snapshot** for automated screenshot generation with XCUITest
- **deliver** for uploading metadata and screenshots to App Store Connect
- **gym** for building the app
- **pilot** for TestFlight distribution
- **App Store Connect API Key** for authentication

## Prerequisites

- Xcode installed
- iOS app project with UI Test target
- Apple Developer account
- fastlane installed: `gem install fastlane`

---

## Directory Structure

```
YourProject/
├── YourApp.xcodeproj
├── YourApp/                    # Main app code
├── YourAppUITests/             # UI Tests for screenshots
│   ├── YourAppUITests.swift
│   └── SnapshotHelper.swift    # Auto-generated by fastlane
├── fastlane/
│   ├── Fastfile                # Lane definitions
│   ├── Appfile                 # App identifiers
│   ├── Snapfile                # Screenshot configuration
│   ├── .env                    # Environment variables (API keys)
│   ├── AuthKey_XXXXX.p8        # App Store Connect API Key file
│   ├── metadata/               # App Store metadata
│   │   ├── copyright.txt
│   │   ├── price_tier.txt
│   │   ├── primary_category.txt
│   │   ├── rating_config.json
│   │   ├── review_information/
│   │   │   ├── email_address.txt
│   │   │   ├── first_name.txt
│   │   │   ├── last_name.txt
│   │   │   ├── phone_number.txt
│   │   │   └── notes.txt
│   │   ├── en-US/
│   │   │   ├── name.txt
│   │   │   ├── subtitle.txt
│   │   │   ├── description.txt
│   │   │   ├── keywords.txt
│   │   │   ├── privacy_url.txt
│   │   │   └── support_url.txt
│   │   └── zh-Hans/
│   │       └── ...
│   └── screenshots/            # Generated screenshots
│       └── en-US/title.strings # Screenshot titles
└── screenshots/                # Output directory (git-ignored)
```

---

## Step 1: Initialize Fastlane

```bash
cd YourProject
fastlane init
```

This creates the `fastlane/` directory with basic files.

---

## Step 2: Configure App Store Connect API Key

### Why Use API Key?

For team accounts, API Key is the best choice:
- ✅ No 2FA prompts during automation
- ✅ More secure than storing passwords
- ✅ Fine-grained permissions
- ✅ CI/CD friendly

### Create API Key

1. Visit [App Store Connect](https://appstoreconnect.apple.com/)
2. Go to **Users and Access** → **Integrations** → **App Store Connect API**
3. Click **+** to generate a new API key
4. Name: `Fastlane Upload`
5. Access: **App Manager** or **Admin**
6. Click **Generate** and **Download API Key** (.p8 file)

⚠️ **Important**: The API Key can only be downloaded once!

### Record Key Information

After creating the key, note:
- **Key ID**: 10 characters (e.g., `8XWFT9BX9U`)
- **Issuer ID**: UUID format (e.g., `8a4771f0-a094-40f8-94e5-712726e9a161`)

### Place API Key File

Move the downloaded `.p8` file to `fastlane/`:

```bash
mv ~/Downloads/AuthKey_8XWFT9BX9U.p8 ./fastlane/
```

### Create .env File

Create `fastlane/.env` with your API key information:

```bash
APP_STORE_CONNECT_KEY_ID=YOUR_KEY_ID
APP_STORE_CONNECT_ISSUER_ID=YOUR_ISSUER_ID
APP_STORE_CONNECT_TEAM_ID=YOUR_TEAM_ID
APP_STORE_CONNECT_API_KEY_PATH=./fastlane/AuthKey_YOUR_KEY_ID.p8
```

**Example**:
```
APP_STORE_CONNECT_KEY_ID=8XWFT9BX9U
APP_STORE_CONNECT_ISSUER_ID=8a4771f0-a094-40f8-94e5-712726e9a161
APP_STORE_CONNECT_TEAM_ID=UWNR93L682
APP_STORE_CONNECT_API_KEY_PATH=./fastlane/AuthKey_8XWFT9BX9U.p8
```

⚠️ **Important**: Add `fastlane/.env` to `.gitignore` to prevent committing secrets!

---

## Step 3: Configure Appfile

Edit `fastlane/Appfile`:

```ruby
app_identifier("com.yourcompany.yourapp")
apple_id("your@email.com")
team_id("YOUR_TEAM_ID")
```

---

## Step 4: Configure Snapfile

Create or edit `fastlane/Snapfile`:

```ruby
# Supported devices
devices([
  "iPhone 17 Pro Max",      # 6.9" display (App Store required)
  "iPhone 17 Pro",          # 6.1" display
  "iPad Pro 13-inch (M4)"   # 13" iPad display (App Store required)
])

# Disable parallel simulators (avoids creating clones)
concurrent_simulators(false)

# Supported languages
languages([
  "en-US",
  "zh-Hans",
  "fr-FR"
])

# Scheme name (must be your MAIN app scheme, NOT UITests target)
scheme("YourApp")

# Only run screenshot tests (skip performance tests)
only_testing([
  "YourAppUITests/YourAppUITests/testTakeScreenshots"
])

# Output directory
output_directory("./screenshots")

# Clear previous screenshots before each run
clear_previous_screenshots(true)

# Override status bar (9:41, full battery, full signal)
override_status_bar(true)

# Continue even if one test fails
stop_after_first_error(false)

# Reinstall app for each language (ensures clean state)
reinstall_app(true)

# Launch arguments for screenshot mode
launch_arguments(["-UITesting -ScreenshotMode"])

# Disable parallel testing (avoids simulator clones)
xcargs("-parallel-testing-enabled NO")
```

### Key Configuration Tips

- **`scheme`**: Use your main app scheme name, **not** the UITests target name
- **`concurrent_simulators(false)`**: Prevents opening multiple simulator windows
- **`xcargs("-parallel-testing-enabled NO")`**: Avoids creating simulator clones
- **`only_testing`**: Runs only screenshot tests, skipping performance tests
- **`launch_arguments`**: Pass flags to detect screenshot mode in your app

---

## Step 5: Configure Fastfile

Create `fastlane/Fastfile` with these lanes:

```ruby
# fastlane/Fastfile

default_platform(:ios)

# Global version number
APP_VERSION = "1.0.0"

platform :ios do

  # ====================================
  # Screenshot Lanes
  # ====================================

  desc "Generate screenshots for all devices and languages"
  lane :screenshots do
    # Shutdown all simulators to avoid clone issues
    sh("xcrun simctl shutdown all")
    snapshot
  end

  # ====================================
  # Upload Lanes
  # ====================================

  desc "Upload screenshots only to App Store Connect"
  lane :upload_screenshots do |options|
    # Get API Key
    api_key = app_store_connect_api_key(
      key_id: ENV["APP_STORE_CONNECT_KEY_ID"],
      issuer_id: ENV["APP_STORE_CONNECT_ISSUER_ID"],
      key_filepath: ENV["APP_STORE_CONNECT_API_KEY_PATH"]
    )

    # Support specifying languages: fastlane ios upload_screenshots languages:zh-Hans
    deliver_options = {
      api_key: api_key,
      skip_binary_upload: true,
      skip_metadata: true,
      skip_screenshots: false,
      force: true,
      overwrite_screenshots: true,
      screenshots_path: "./screenshots",
      precheck_include_in_app_purchases: false
    }

    # Add languages parameter if specified
    if options[:languages]
      deliver_options[:languages] = options[:languages].split(",")
    end

    deliver(deliver_options)
  end

  desc "Upload metadata only to App Store Connect"
  lane :upload_metadata do
    # Get API Key
    api_key = app_store_connect_api_key(
      key_id: ENV["APP_STORE_CONNECT_KEY_ID"],
      issuer_id: ENV["APP_STORE_CONNECT_ISSUER_ID"],
      key_filepath: ENV["APP_STORE_CONNECT_API_KEY_PATH"]
    )

    begin
      deliver(
        api_key: api_key,
        skip_binary_upload: true,
        skip_metadata: false,
        skip_screenshots: true,
        force: true,
        precheck_include_in_app_purchases: false,
        run_precheck_before_submit: false
      )
    rescue => e
      # Ignore "No data" error - metadata was uploaded successfully
      if e.message.include?("No data")
        UI.important("Ignoring 'No data' error - metadata was uploaded successfully")
      else
        raise e
      end
    end
  end

  desc "Upload metadata and screenshots to App Store Connect"
  lane :upload do
    # Get API Key
    api_key = app_store_connect_api_key(
      key_id: ENV["APP_STORE_CONNECT_KEY_ID"],
      issuer_id: ENV["APP_STORE_CONNECT_ISSUER_ID"],
      key_filepath: ENV["APP_STORE_CONNECT_API_KEY_PATH"]
    )

    deliver(
      api_key: api_key,
      skip_binary_upload: true,
      skip_metadata: false,
      skip_screenshots: false,
      force: true,
      overwrite_screenshots: true,
      screenshots_path: "./screenshots",
      precheck_include_in_app_purchases: false,
      run_precheck_before_submit: false
    )
  end

  # ====================================
  # Build Lanes
  # ====================================

  desc "Build app (auto-increment build number)"
  lane :build do |options|
    # Authenticate with App Store Connect API Key
    app_store_connect_api_key(
      key_id: ENV["APP_STORE_CONNECT_KEY_ID"],
      issuer_id: ENV["APP_STORE_CONNECT_ISSUER_ID"],
      key_filepath: ENV["APP_STORE_CONNECT_API_KEY_PATH"]
    )

    # Set version number (use global APP_VERSION or override with parameter)
    version = options[:version] || APP_VERSION
    increment_version_number(
      version_number: version,
      xcodeproj: "YourApp.xcodeproj"
    )

    # Auto-increment build number
    increment_build_number(
      xcodeproj: "YourApp.xcodeproj"
    )

    # Build .ipa (using Xcode automatic signing)
    gym(
      scheme: "YourApp",
      output_directory: "./build",
      output_name: "YourApp.ipa",
      export_method: "app-store",
      export_options: {
        signingStyle: "automatic",
        teamID: ENV["APP_STORE_CONNECT_TEAM_ID"]
      }
    )
  end

  desc "Build and upload to TestFlight"
  lane :release do |options|
    # Authenticate with App Store Connect API Key
    api_key = app_store_connect_api_key(
      key_id: ENV["APP_STORE_CONNECT_KEY_ID"],
      issuer_id: ENV["APP_STORE_CONNECT_ISSUER_ID"],
      key_filepath: ENV["APP_STORE_CONNECT_API_KEY_PATH"]
    )

    # Build
    build(options)

    # Upload to TestFlight
    upload_to_testflight(
      api_key: api_key,
      skip_waiting_for_build_processing: true
    )
  end

  # ====================================
  # Utility Lanes
  # ====================================

  desc "Download current metadata from App Store Connect"
  lane :download_metadata do
    # Get API Key
    api_key = app_store_connect_api_key(
      key_id: ENV["APP_STORE_CONNECT_KEY_ID"],
      issuer_id: ENV["APP_STORE_CONNECT_ISSUER_ID"],
      key_filepath: ENV["APP_STORE_CONNECT_API_KEY_PATH"]
    )

    deliver(
      api_key: api_key,
      download_metadata: true,
      app_identifier: "com.yourcompany.yourapp"
    )
  end

  desc "Validate screenshots and metadata (without uploading)"
  lane :validate do
    deliver(
      skip_binary_upload: true,
      force: true,
      submit_for_review: false,
      run_precheck_before_submit: false
    )
  end

end
```

### Key Fastfile Features

- **`sh("xcrun simctl shutdown all")`**: Prevents simulator clone issues
- **Error handling for "No data"**: Common false error when uploading metadata
- **Language-specific uploads**: `fastlane ios upload_screenshots languages:zh-Hans`
- **Auto-increment build number**: Managed by fastlane
- **Xcode automatic signing**: Uses your Xcode signing configuration

---

## Step 6: Create UI Tests

### Create UI Test Target

If you don't have one yet:
1. File → New → Target → UI Testing Bundle
2. Name: `YourAppUITests`

### Add Accessibility Identifiers

In your SwiftUI views:

```swift
// HomeView.swift
Button("Start Game") {
    startGame()
}
.accessibilityIdentifier("start_game_button")

Button(action: openSettings) {
    Image(systemName: "gearshape")
}
.accessibilityIdentifier("settings_button")
```

### Initialize SnapshotHelper

```bash
cd fastlane
fastlane snapshot init
```

This downloads `SnapshotHelper.swift` to your UITests directory.

**Important**: Add `SnapshotHelper.swift` to your Xcode project:
1. Right-click `YourAppUITests` folder in Xcode
2. Add Files to 'YourApp'...
3. Select `SnapshotHelper.swift`
4. Check `YourAppUITests` target

### Write Screenshot Tests

Create or edit `YourAppUITests/YourAppUITests.swift`:

```swift
import XCTest

final class YourAppUITests: XCTestCase {

    var app: XCUIApplication!

    @MainActor
    override func setUpWithError() throws {
        continueAfterFailure = false

        // Explicitly specify bundle identifier (avoids launching wrong app)
        app = XCUIApplication(bundleIdentifier: "com.yourcompany.yourapp")
        setupSnapshot(app)
        app.launch()

        // Wait for app to fully load
        Thread.sleep(forTimeInterval: 2)
    }

    override func tearDownWithError() throws {
        app = nil
    }

    // MARK: - Screenshot Test

    @MainActor
    func testTakeScreenshots() throws {
        // ========================================
        // Screenshot 1: Home Screen
        // ========================================

        // Wait for home screen to load
        let startButton = app.buttons["start_game_button"]
        XCTAssertTrue(startButton.waitForExistence(timeout: 5))

        // Wait for animations
        Thread.sleep(forTimeInterval: 1)
        snapshot("01_HomeScreen")

        // ========================================
        // Screenshot 2: Settings Screen
        // ========================================

        let settingsButton = app.buttons["settings_button"]
        XCTAssertTrue(settingsButton.waitForExistence(timeout: 3))
        settingsButton.tap()

        // Wait for settings to load
        Thread.sleep(forTimeInterval: 1)
        snapshot("02_SettingsScreen")

        // Go back
        let backButton = app.navigationBars.buttons.firstMatch
        if backButton.exists {
            backButton.tap()
        }
        Thread.sleep(forTimeInterval: 1)

        // ========================================
        // Screenshot 3: Game Screen
        // ========================================

        // Start game
        let startGameButton = app.buttons["start_game_button"]
        XCTAssertTrue(startGameButton.waitForExistence(timeout: 3))
        startGameButton.tap()

        // Wait for game screen
        Thread.sleep(forTimeInterval: 2)

        // Skip tutorial if present
        let skipTutorialButton = app.buttons["skip_tutorial_button"]
        if skipTutorialButton.waitForExistence(timeout: 2) {
            skipTutorialButton.tap()
            Thread.sleep(forTimeInterval: 1)
        }

        snapshot("03_GameScreen")
    }
}
```

### Key Testing Practices

- **`@MainActor`**: Required for UI operations in Swift 6+
- **`bundleIdentifier`**: Explicitly specify to avoid launching wrong app
- **`waitForExistence(timeout:)`**: Better than `sleep()` for waiting
- **Naming**: Use numeric prefixes (01_, 02_) for correct ordering
- **Error handling**: Handle optional UI elements (tutorial, dialogs)

---

## Step 7: Configure Metadata

### Create Metadata Files

```bash
cd fastlane
mkdir -p metadata/en-US
mkdir -p metadata/zh-Hans
mkdir -p metadata/review_information
```

### Fill In Metadata

**Global metadata** (`fastlane/metadata/`):

| File | Content | Example |
|------|---------|---------|
| `copyright.txt` | Copyright notice | `2026 YourCompany` |
| `price_tier.txt` | Pricing tier (0 = free) | `0` |
| `primary_category.txt` | App Store category | `EDUCATION` |

**Review information** (`metadata/review_information/`):

| File | Content |
|------|---------|
| `first_name.txt` | Your first name |
| `last_name.txt` | Your last name |
| `email_address.txt` | Contact email |
| `phone_number.txt` | Phone (international format: `+1 555-123-4567`) |
| `notes.txt` | Instructions for reviewers |

**Language-specific metadata** (`metadata/en-US/`, `metadata/zh-Hans/`, etc.):

| File | Max Length | Required | Description |
|------|-----------|----------|-------------|
| `name.txt` | 30 chars | ✅ | App name |
| `subtitle.txt` | 30 chars | ❌ | Subtitle (iOS 11+) |
| `description.txt` | 4000 chars | ✅ | Full description |
| `keywords.txt` | 100 chars | ✅ | Comma-separated keywords (no spaces) |
| `privacy_url.txt` | - | ✅ | Privacy policy URL |
| `support_url.txt` | - | ✅ | Support URL |

**Example `keywords.txt`**:
```
japanese,hiragana,katakana,kana,learn,education,match,game,puzzle
```

**Example `rating_config.json`**:
```json
{
  "CARTOON_FANTASY_VIOLENCE": 0,
  "REALISTIC_VIOLENCE": 0,
  "PROLONGED_GRAPHIC_SADISTIC_REALISTIC_VIOLENCE": 0,
  "PROFANITY_CRUDE_HUMOR": 0,
  "MATURE_SUGGESTIVE": 0,
  "HORROR": 0,
  "MEDICAL_TREATMENT_INFO": 0,
  "ALCOHOL_TOBACCO_DRUGS": 0,
  "GAMBLING": 0,
  "SEXUAL_CONTENT_NUDITY": 0,
  "GRAPHIC_SEXUAL_CONTENT_NUDITY": 0,
  "UNRESTRICTED_WEB_ACCESS": 0,
  "GAMBLING_CONTESTS": 0
}
```

See `metadata-structure.md` for complete field reference.

---

## Step 8: Run Fastlane

### Generate Screenshots

```bash
fastlane ios screenshots
```

Screenshots will be saved to `screenshots/` directory.

### Upload Screenshots Only

```bash
fastlane ios upload_screenshots
```

Upload specific language:
```bash
fastlane ios upload_screenshots languages:zh-Hans
```

### Upload Metadata Only

```bash
fastlane ios upload_metadata
```

### Upload Everything

```bash
fastlane ios upload
```

### Build and Release

```bash
# Build only
fastlane ios build

# Build and upload to TestFlight
fastlane ios release

# Build with custom version
fastlane ios build version:1.2.0
```

---

## Common Workflows

### Initial Setup

```bash
# 1. Download existing metadata from App Store Connect
fastlane ios download_metadata

# 2. Generate screenshots
fastlane ios screenshots

# 3. Upload everything
fastlane ios upload
```

### Update Screenshots Only

```bash
fastlane ios screenshots
fastlane ios upload_screenshots
```

### Update Metadata Only

Edit files in `metadata/`, then:

```bash
fastlane ios upload_metadata
```

### Full Release Workflow

```bash
# 1. Generate new screenshots
fastlane ios screenshots

# 2. Upload screenshots and metadata
fastlane ios upload

# 3. Build and upload to TestFlight
fastlane ios release
```

---

## Troubleshooting

### Common Issues

**1. "Couldn't find specified scheme 'YourAppUITests'"**

Solution: Use your main app scheme name, not the UITests target:
```ruby
scheme("YourApp")  # Correct
# scheme("YourAppUITests")  # Wrong
```

**2. "Snapshot Helper file is missing"**

Solution: Add `SnapshotHelper.swift` to your Xcode project (see Step 6).

**3. Simulator clones being created**

Solution: Add to Snapfile:
```ruby
concurrent_simulators(false)
xcargs("-parallel-testing-enabled NO")
```

**4. Authentication failed**

Solution: Check your `.env` file and API Key configuration.

See `troubleshooting-ios.md` for complete troubleshooting guide.

---

## Security Best Practices

### ✅ Do

- ✅ Use `.env` file for sensitive data
- ✅ Add `fastlane/.env` to `.gitignore`
- ✅ Add `*.p8` to `.gitignore`
- ✅ Use API Key instead of password authentication
- ✅ Backup `.p8` file to secure location (password manager)
- ✅ Rotate API Keys every 6-12 months

### ❌ Don't

- ❌ Commit `.env` or `.p8` files to Git
- ❌ Share API Key information publicly
- ❌ Store `.p8` files in cloud sync folders (Dropbox, iCloud)
- ❌ Print API Key info in CI/CD logs

---

## Complete Example .gitignore

```gitignore
# Fastlane
fastlane/report.xml
fastlane/Preview.html
fastlane/screenshots/**/*.png
fastlane/screenshots/.frameit-staging/
fastlane/test_output

# Sensitive files
*.p8
fastlane/AuthKey_*.p8
fastlane/.env

# Build artifacts
build/
*.ipa
*.dSYM.zip
```

---

## Next Steps

1. Configure your app identifiers in `Appfile`
2. Set up App Store Connect API Key
3. Create `.env` file with your credentials
4. Configure `Snapfile` for your devices/languages
5. Add accessibility identifiers to your views
6. Write UI tests for screenshots
7. Run `fastlane ios screenshots` to test
8. Fill in `metadata/` files
9. Run `fastlane ios upload` to deploy

---

## Resources

- [Fastlane Snapshot Documentation](https://docs.fastlane.tools/actions/snapshot/)
- [Fastlane Deliver Documentation](https://docs.fastlane.tools/actions/deliver/)
- [App Store Connect API Documentation](https://developer.apple.com/documentation/appstoreconnectapi)
- See `api-key-setup.md` for detailed API Key setup
- See `ios-snapshot.md` for snapshot-specific tips
- See `troubleshooting-ios.md` for common issues
